DELIMITER //
create procedure cre_fretable()begin declare d_booking_no int;declare d_space_name text;declare d_sd datetime;declare d_ed datetime;declare now_checking_booking int;declare s_time time;declare e_time time;declare tdiff time;declare d_year int;declare d_month int;declare Cur_booking_space_sd_ed cursor for select new_essential.booking_no, space_name, start_date,end_date from new_essential INNER JOIN service ON service.booking_no=new_essential.booking_no order by booking_no;declare Cur_now_checking_booking cursor for select booking_no from now_checking_booking_no LIMIT 1;open Cur_now_checking_booking;fetch Cur_now_checking_booking into now_checking_booking;close Cur_now_checking_booking;open Cur_booking_space_sd_ed;set @pos=0;select count(*) into @total from new_essential;while @total > @pos do fetch Cur_booking_space_sd_ed into d_booking_no, d_space_name, d_sd, d_ed;if(now_checking_booking < d_booking_no) then begin declare Cur_st cursor for select cast(d_sd as time);declare Cur_et cursor for select cast(d_ed as time);declare Cur_year_month cursor for select date_format(d_sd,'%Y') as year,date_format(d_sd,'%m') as month;open Cur_st;open Cur_et;fetch Cur_st into s_time;fetch Cur_et into e_time;close Cur_st;close Cur_et;open Cur_year_month;fetch Cur_year_month into d_year,d_month;close Cur_year_month;if(e_time<s_time) then begin declare Cur_ei cursor for select e_time+interval 1 day as e_time;open Cur_ei;fetch Cur_ei into e_time;end;end if;set @d_count = 0;select count(*) into @d_count from frequency where space_name=d_space_name AND year=d_year AND month=d_month;if(@d_count=0) then begin declare Cur_tdiff cursor for select timediff(e_time,s_time);open Cur_tdiff;fetch Cur_tdiff into tdiff;close Cur_tdiff;insert into frequency values (d_space_name,d_year,d_month,tdiff);end;else begin declare d_totaltime time;declare Cur_tdiff cursor for select timediff(e_time,s_time);declare Cur_usetotaltime cursor for select use_totaltime from frequency where space_name=d_space_name AND year=d_year AND month=d_month;open Cur_tdiff;fetch Cur_tdiff into tdiff;close Cur_tdiff;open Cur_usetotaltime;fetch Cur_usetotaltime into d_totaltime;close Cur_usetotaltime;update frequency,(select addtime(d_totaltime,tdiff) as total_time) as T set frequency.use_totaltime=T.total_time where frequency.space_name=d_space_name AND frequency.year=d_year AND frequency.month=d_month;end;end if;end;end if;set @pos=@pos+1;update now_checking_booking_no set booking_no=d_booking_no;end while;close Cur_booking_space_sd_ed;end;//
DELIMITER ;
